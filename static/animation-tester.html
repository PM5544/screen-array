<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vh;
    }

    html {
      background: black;
      font-family: sans-serif;
    }
  </style>
</head>
<body><canvas></canvas></body>
<script type="module">
  import Animation from './animations/AudioLines.mjs';
  import { clear, ctx, dimensions } from './client/canvas.mjs';

  let oldLevels = [];
  const iterations = 10;
  let iterationCounter = iterations;
  let newLevels = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

  function makeNewAudioLevels() {
    oldLevels = [].concat(newLevels);

    newLevels.length = 0;
    for (let i = 12; i >= 1; i--) {
      newLevels.push(Math.round(Math.random() * 100));
    }
  }

  function calculate(a, b, percentage) {
    if (a === b) {
      return a;
    }
    if (a > b) {
      const dif = ((a - b) / 100) * percentage;
      return Math.round(b + dif);
    }

    const dif = ((b - a) / 100) * percentage;
    return Math.round(a + dif);
  }

  function getAudioLevels() {
    // return {
    //   right: [50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50],
    //   left: [50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50]
    // };

    const levels = [];
    for (let i = 0; i < 12; i++) {
      levels.push(calculate(oldLevels[i], newLevels[i], (100 / iterations) * iterationCounter));
    }

    iterationCounter--;
    if (0 === iterationCounter) {
      iterationCounter = iterations;
      makeNewAudioLevels();
    }

    return {
      spectrum: levels
    };
  }

  const animation = new Animation({ index: 0, total: 3, mirrored: false });

  makeNewAudioLevels();

  function drawFrame() {
    clear();
    animation.render(ctx, dimensions, getAudioLevels());
    window.requestAnimationFrame(drawFrame);
  }

  window.requestAnimationFrame(drawFrame);

</script>
</html>
